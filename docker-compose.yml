# =============================================================================
# Antigravity Remote Docker - Docker Compose Configuration
# =============================================================================
# Usage:
#   Start:    docker-compose up -d
#   Stop:     docker-compose down
#   Logs:     docker-compose logs -f
#   Rebuild:  docker-compose up -d --build
# =============================================================================

services:
  antigravity:
    build:
      context: .
      args:
        GPU_TYPE: ${GPU_TYPE:-nvidia}
      dockerfile: Dockerfile
    image: antigravity-remote:latest
    container_name: antigravity-remote

    # =========================================================================
    # Runtime Configuration
    # =========================================================================
    # Runtime varies by GPU type (nvidia, amd, runc)
    runtime: ${DOCKER_RUNTIME:-runc}
    
    # Device mappings for AMD and Intel
    devices: ${GPU_DEVICES:-[]}
    
    # Security options (needed for AMD)
    security_opt: ${SECURITY_OPTS:-[]}
    
    # Group memberships (video/render)
    group_add: ${GPU_GROUPS:-[]}

    # =========================================================================
    # GPU Resource Reservations (For NVIDIA strict mode)
    # =========================================================================
    # Only applies when using NVIDIA runtime
    deploy:
      resources:
        reservations:
          # This variable can be empty for non-NVIDIA setups
          devices: ${DEPLOY_DEVICES:-[]}
        limits:
          memory: 16G
          cpus: '8'

    # =========================================================================
    # Environment Variables
    # =========================================================================
    environment:
      # GPU Configuration
      - GPU_TYPE=${GPU_TYPE:-nvidia}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-all}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-all}
      - AMD_VISIBLE_DEVICES=${AMD_VISIBLE_DEVICES:-all}
      - ROCm_VISIBLE_DEVICES=${ROCm_VISIBLE_DEVICES:-all}
      - LIBVA_DRIVER_NAME=${LIBVA_DRIVER_NAME:-iHD}
      - ONEAPI_DEVICE_SELECTOR=${ONEAPI_DEVICE_SELECTOR:-*}

      # Display settings
      - DISPLAY_WIDTH=${DISPLAY_WIDTH:-1920}
      - DISPLAY_HEIGHT=${DISPLAY_HEIGHT:-1080}
      - DISPLAY_DEPTH=24

      # VNC password - REQUIRED!
      - VNC_PASSWORD=${VNC_PASSWORD}

      # Timezone
      - TZ=${TZ:-America/Denver}

      # Auto-update Antigravity
      - ANTIGRAVITY_AUTO_UPDATE=true

      # Auto-launch Antigravity
      - AUTOSTART_ANTIGRAVITY=${AUTOSTART_ANTIGRAVITY:-true}

      # Idle optimization settings
      - IDLE_CHECK_INTERVAL=${IDLE_CHECK_INTERVAL:-30}
      - IDLE_TIMEOUT=${IDLE_TIMEOUT:-60}
      - IDLE_PAUSE_ANTIGRAVITY=${IDLE_PAUSE_ANTIGRAVITY:-false}

    # =========================================================================
    # Port Mappings
    # =========================================================================
    ports:
      - "${NOVNC_PORT:-6080}:6080" # noVNC web interface
      - "${VNC_PORT:-5901}:5901"   # Direct VNC access

    # =========================================================================
    # Volume Mounts
    # =========================================================================
    volumes:
      - ./data/workspace:/home/antigravity/workspace
      - ./data/config:/home/antigravity/.config
      - ./data/antigravity:/home/antigravity/.antigravity
      # - /tmp/.X11-unix:/tmp/.X11-unix:ro # Share clipboard (Linux)

    # Shared memory for better performance
    shm_size: '2gb'

    # Always restart unless stopped manually
    restart: unless-stopped

    # =========================================================================
    # Health Check
    # =========================================================================
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: antigravity-network
