# =============================================================================
# Antigravity Remote Docker - Docker Compose Configuration
# =============================================================================
# Usage:
#   Start:    podman-compose up -d (or docker-compose up -d)
#   Stop:     podman-compose down
#   Logs:     podman-compose logs -f
#   Rebuild:  podman-compose up -d --build
# =============================================================================

services:
  antigravity:
    build:
      context: .
      args:
        GPU_TYPE: ${GPU_TYPE:-cpu}
      dockerfile: Dockerfile
    image: antigravity-remote:latest
    container_name: antigravity-remote

    # =========================================================================
    # Runtime Configuration
    # =========================================================================
    # Note: For NVIDIA runtime, set DOCKER_RUNTIME=nvidia in .env
    # For podman, use: podman run --device nvidia.com/gpu=all
    runtime: ${DOCKER_RUNTIME:-}

    # =========================================================================
    # Device Mappings
    # =========================================================================
    # For Intel/AMD: /dev/dri is passed through
    # Uncomment additional devices as needed in your .env or override file
    devices:
      - /dev/dri:/dev/dri

    # =========================================================================
    # Security Options
    # =========================================================================
    # AMD ROCm may require seccomp=unconfined - add via override if needed
    # security_opt:
    #   - seccomp=unconfined

    # =========================================================================
    # Group Memberships (for GPU device access)
    # =========================================================================
    # Add video group for GPU access
    # Note: 'render' group may not exist in container; add via override if needed
    group_add:
      - video

    # =========================================================================
    # Resource Limits
    # =========================================================================
    deploy:
      resources:
        limits:
          memory: 16G
          cpus: '8'

    # =========================================================================
    # Environment Variables
    # =========================================================================
    environment:
      # GPU Configuration
      - GPU_TYPE=${GPU_TYPE:-cpu}
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES:-}
      - NVIDIA_DRIVER_CAPABILITIES=${NVIDIA_DRIVER_CAPABILITIES:-}
      - AMD_VISIBLE_DEVICES=${AMD_VISIBLE_DEVICES:-}
      - ROCm_VISIBLE_DEVICES=${ROCm_VISIBLE_DEVICES:-}
      - LIBVA_DRIVER_NAME=${LIBVA_DRIVER_NAME:-iHD}
      - ONEAPI_DEVICE_SELECTOR=${ONEAPI_DEVICE_SELECTOR:-*}

      # Display settings
      - DISPLAY_WIDTH=${DISPLAY_WIDTH:-1920}
      - DISPLAY_HEIGHT=${DISPLAY_HEIGHT:-1080}
      - DISPLAY_DEPTH=24

      # VNC password - REQUIRED!
      - VNC_PASSWORD=${VNC_PASSWORD}

      # Timezone
      - TZ=${TZ:-America/Denver}

      # Auto-update Antigravity
      - ANTIGRAVITY_AUTO_UPDATE=true

      # Auto-launch Antigravity
      - AUTOSTART_ANTIGRAVITY=${AUTOSTART_ANTIGRAVITY:-true}

      # Idle optimization settings
      - IDLE_CHECK_INTERVAL=${IDLE_CHECK_INTERVAL:-30}
      - IDLE_TIMEOUT=${IDLE_TIMEOUT:-60}
      - IDLE_PAUSE_ANTIGRAVITY=${IDLE_PAUSE_ANTIGRAVITY:-false}

    # =========================================================================
    # Port Mappings
    # =========================================================================
    ports:
      - "${NOVNC_PORT:-6080}:6080" # noVNC web interface
      - "${VNC_PORT:-5901}:5901"   # Direct VNC access

    # =========================================================================
    # Volume Mounts
    # =========================================================================
    volumes:
      - ./data/workspace:/home/antigravity/workspace
      - ./data/config:/home/antigravity/.config
      - ./data/antigravity:/home/antigravity/.antigravity

    # Shared memory for better performance
    shm_size: '2gb'

    # Always restart unless stopped manually
    restart: unless-stopped

    # =========================================================================
    # Health Check
    # =========================================================================
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: antigravity-network
